<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Room</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/open-iconic/1.1.1/font/css/open-iconic-bootstrap.min.css">
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script src="https://rawgit.com/netology-group/mqtt-client-js/master/dist/index.js"></script>
    <script src="https://rawgit.com/netology-group/signals-js/master/dist/index.js"></script>
</head>
<body>

<div class="container">
    <div class="row">
        <div class="col-sm-12">
            <button id="connectBtn" type="button" class="btn btn-light">Connect</button>
            <button id="joinBtn" type="button" class="btn btn-success">Join room</button>
            <button id="leaveBtn" type="button" class="btn btn-danger" hidden disabled>Leave room</button>
            <button id="getUserMediaBtn" type="button" class="btn btn-light">Get user media</button>
            <button id="stopUserMediaBtn" type="button" class="btn btn-light">Stop user media</button>
        </div>
    </div>
    <div class="row">
        <div class="col-sm-6">
            <h2>Agents</h2>
            <div id="listAgents">

            </div>
        </div>
    </div>
</div>

<script>
    const connectBtn = document.getElementById('connectBtn')
    const joinBtn = document.getElementById('joinBtn')
    const leaveBtn = document.getElementById('leaveBtn')
    const getUserMediaBtn = document.getElementById('getUserMediaBtn')
    const stopUserMediaBtn = document.getElementById('stopUserMediaBtn')
    const listAgentsContainer = document.getElementById('listAgents')

    const params = getParams(location.search.slice(1))

    const BROKER = decodeURIComponent(params.url)
    const ACCOUNT_ID = params.account_id
    const AGENT_ID = params.agent_id
    const ROOM_ID = params.room_id
    const APP_NAME = params.app_name
    const OPTIONS = {
        username: `user-${ACCOUNT_ID}`,
        password: `password-${ACCOUNT_ID}`,
        clientId: `${AGENT_ID}.${ACCOUNT_ID}`,
        will: {
            topic: `agents/${AGENT_ID}/out/${APP_NAME}/api/v1`,
            payload: `{"jsonrpc":"2.0","method":"agent.delete","params":[{"room_id":"${ROOM_ID}","id":"${AGENT_ID}"}],"id":"${AGENT_ID}"}`
        }
    }

    let mqttClient = null
    let signals = null
    let agentSub = null
    let trackSub = null
    let mediaStream = null
    let agentList = []
    let trackList = []

    function handleAgentSubscriptionEvent (event) {
        console.log('[agentSubscription:event]', event.type, event.data)

        listAgents().then(function (response) {
            agentList = response

            renderAgentList()
        })
    }

    function handleTrackSubscriptionEvent (event) {
        console.log('[trackSubscription:event]', event.type, event.data)

        listTracks().then(function (response) {
            trackList = response

            renderAgentList()
        })
    }

    function bindListeners () {
        signals.subscribeAgents(ROOM_ID).then((agentSubscription) => {
            agentSub = agentSubscription
            agentSub.on('create', handleAgentSubscriptionEvent)
            agentSub.on('delete', handleAgentSubscriptionEvent)
        })

        signals.subscribeTracks(ROOM_ID).then((trackSubscription) => {
            trackSub = trackSubscription
            trackSub.on('create', handleTrackSubscriptionEvent)
            trackSub.on('update', handleTrackSubscriptionEvent)
            trackSub.on('delete', handleTrackSubscriptionEvent)
        })
    }

    function unbindListeners () {
        agentSub.off('create', handleAgentSubscriptionEvent)
        agentSub.off('delete', handleAgentSubscriptionEvent)
        agentSub = null
        trackSub.off('create', handleTrackSubscriptionEvent)
        trackSub.off('update', handleTrackSubscriptionEvent)
        trackSub.off('delete', handleTrackSubscriptionEvent)
        trackSub = null
    }

    connectBtn.addEventListener('click', function (event) {
        connect()
    })

    joinBtn.addEventListener('click', function (event) {
        joinBtn.disabled = true

        joinRoom(ROOM_ID, `Client ${AGENT_ID.split('-')[0]}`).then(function () {
            joinBtn.hidden = true
            leaveBtn.disabled = false
            leaveBtn.hidden = false

            bindListeners()

            Promise.all([listAgents(), listTracks()]).then(function (responseList) {
                agentList = responseList[0]
                trackList = responseList[1]

                renderAgentList()
            })
        })
    })

    leaveBtn.addEventListener('click', function (event) {
        leaveBtn.disabled = true

        leaveRoom(ROOM_ID, AGENT_ID).then(function () {
            joinBtn.disabled = false
            joinBtn.hidden = false
            leaveBtn.hidden = true

            unbindListeners()

            agentList = []

            if (mediaStream !== null) {
                mediaStream.getTracks().forEach(function (track) {
                    track.stop()
                })
                mediaStream = null
            }

            renderAgentList()
        })
    })

    getUserMediaBtn.addEventListener('click', function (event) {
        gum().then(function (stream) {
            mediaStream = stream

            submitTracks(mediaStream)
        })
    })

    stopUserMediaBtn.addEventListener('click', function (event) {
        if (mediaStream !== null) {
            mediaStream.getTracks().forEach(function (track) {
                let trackId = getTrackByTrackId(track.id)

                removeTrack(trackId).then((response) => {
                    track.stop()
                })
            })

            mediaStream = null
        }
    })

    function listAgents () {
        return signals.listAgents(`room_id:${ROOM_ID}`).then((response) => {
            console.log('[listAgents]', response)

            return response
        })
    }

    function createTrack (track) {
        return signals.createTrack(ROOM_ID, track).then((response) => {
            console.log('[createTrack]', response)

            return response
        })
    }

    function listTracks () {
        return signals.listTracks(`room_id:${ROOM_ID}`).then((response) => {
            console.log('[listTracks]', response)

            return response
        })
    }

    function removeTrack (trackId) {
        return signals.deleteTrack(ROOM_ID, trackId).then((response) => {
            console.log('[deleteTrack]', response)

            return response
        })
    }

    function getTrackByTrackId (trackId) {
        let tracks = trackList.filter((track) => track.data.track_id === trackId)

        return tracks.length ? tracks[0].id : null
    }

    function getTracksByOwnerId (ownerId) {
        return trackList.filter((track) => track.data.owner_id === ownerId)
    }

    function submitTracks(stream) {
        stream.getTracks().forEach(function (track) {
            createTrack({
                streamId: stream.id,
                trackId: track.id,
                device: 'camera',
                kind: track.kind,
                label: track.label
            })
        })
    }

    function connect () {
        mqttClient = new MQTTClient(BROKER, OPTIONS)
        signals = new Signals(mqttClient, AGENT_ID, APP_NAME)

        mqttClient.on(MQTTClient.events.CLOSE, function() {
            console.log('[mqttClient] close')
        })

        mqttClient.on(MQTTClient.events.OFFLINE, function() {
            console.log('[mqttClient] offline')
        })

        mqttClient.on(MQTTClient.events.CONNECT, function () {
            console.log('[mqttClient] connected')
        })

        mqttClient.on(MQTTClient.events.ERROR, function () {
            console.log('[mqttClient] error')
        })

//        mqttClient.subscribe(`agents/${AGENT_ID}/out/${APP_NAME}/api/v1`)
//        mqttClient.on('message', function (topic, message) {
//            const envelope = JSON.parse(message.toString())
//            const payload = JSON.parse(envelope.msg)
//
//            console.groupCollapsed('[message]')
//            console.log('[topic]', topic)
//            console.log('[envelope sub]', envelope.sub)
//            console.log('[envelope msg]', envelope.msg)
//            console.log('[payload]', payload)
//            console.groupEnd()
//        })
    }

    function joinRoom (roomId, label) {
        return signals.createAgent(roomId, {label}).then(function (response) {
            console.log('[response] signals.createAgent', response)

            return response
        }).catch((error) => {
            console.log('[createAgent error]', error)
        })
    }

    function leaveRoom (roomId, agentId) {
        return signals.deleteAgent(roomId, agentId).then(function (response) {
            console.log('[response] signals.deleteAgent', response)

            return response
        }).catch((error) => {
            console.log('[deleteAgent error]', error)
        })
    }

    function gum () {
        const constraints = {audio: true, video: true}

        return navigator.mediaDevices.getUserMedia(constraints)
            .then(function(stream) {
                console.log('[getUserMedia] stream', stream)
                console.log('[getUserMedia] tracks', stream.getTracks())

                return stream
            })
            .catch(function(error) {
                console.log('[gum] error', error)
            });
    }

    function renderAgentList () {
        let content = ''

        agentList.forEach((item) => {
            let text = item.data.label
            let iconList = ''

            getTracksByOwnerId(item.id).forEach((track) => {
                let icon = ''

                switch (track.data.kind) {
                    case 'audio':
                        icon = 'oi-volume-high'
                        break
                    case 'video':
                        icon = 'oi-video'
                        break
                    default:
                        icon = 'oi-question-mark'
                }

                iconList += `<span class="oi ${icon}" title="${track.data.label}"></span>&nbsp;`
            })

            iconList = `<span>${iconList}</span>`

            if (item.id === AGENT_ID) {
                text = `<b>${text}</b>`
            }

            content += `<li class="list-group-item" title="${item.id}">${iconList}${text}</li>`
        })

        content = `<ul class="list-group">${content}</ul>`

        listAgentsContainer.innerHTML = content
    }

    function getParams (qs) {
        const params = {}

        qs.split('&').map((str) => {
            const [ key, value ] = str.split('=')
            params[key] = value
        })

        return params
    }
</script>

</body>
</html>